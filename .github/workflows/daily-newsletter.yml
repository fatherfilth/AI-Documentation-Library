# Daily Newsletter — DISABLED
# Cron schedule removed to stop failure notifications.
# SMTP secrets are not yet configured. Re-enable the cron trigger
# after adding: SMTP_SERVER, SMTP_PORT, SMTP_USERNAME, SMTP_PASSWORD,
# NEWSLETTER_TO, NEWSLETTER_FROM to repository secrets.
#
# To re-enable, uncomment the schedule block below.

name: Daily Newsletter

on:
  # schedule:
  #   - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      date_override:
        description: 'Override date (YYYY-MM-DD). Defaults to today.'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  NEWSLETTER_DATE: ''
  NEWSLETTER_YEAR: ''
  NEWSLETTER_MONTH: ''

jobs:
  collect-and-generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check SMTP secrets
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        run: |
          if [ -z "$SMTP_SERVER" ]; then
            echo "::warning::SMTP secrets not configured — newsletter will collect data but cannot send email."
            echo "Add SMTP_SERVER, SMTP_PORT, SMTP_USERNAME, SMTP_PASSWORD, NEWSLETTER_TO, NEWSLETTER_FROM to repo secrets."
          fi

      - name: Set date metadata
        id: meta
        run: |
          if [ -n "${{ inputs.date_override }}" ]; then
            DATE="${{ inputs.date_override }}"
          else
            DATE=$(date -u +%Y-%m-%d)
          fi
          YEAR=$(echo $DATE | cut -d'-' -f1)
          MONTH=$(echo $DATE | cut -d'-' -f2)
          echo "date=$DATE" >> "$GITHUB_OUTPUT"
          echo "year=$YEAR" >> "$GITHUB_OUTPUT"
          echo "month=$MONTH" >> "$GITHUB_OUTPUT"
          echo "NEWSLETTER_DATE=$DATE" >> "$GITHUB_ENV"
          echo "NEWSLETTER_YEAR=$YEAR" >> "$GITHUB_ENV"
          echo "NEWSLETTER_MONTH=$MONTH" >> "$GITHUB_ENV"
          echo "✅ Newsletter date: $DATE"

      - name: Collect merged PRs (past 24h)
        id: learnings
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SINCE=$(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-24H +%Y-%m-%dT%H:%M:%SZ)
          echo "Collecting PRs merged since: $SINCE"

          gh pr list \
            --repo ${{ github.repository }} \
            --state merged \
            --search "merged:>=$SINCE" \
            --json number,title,mergedAt,headRefName,url,body \
            --limit 50 > /tmp/merged_prs.json

          COUNT=$(jq length /tmp/merged_prs.json)
          echo "has_learnings=$([ $COUNT -gt 0 ] && echo true || echo false)" >> "$GITHUB_OUTPUT"
          echo "pr_count=$COUNT" >> "$GITHUB_OUTPUT"
          echo "✅ Learnings collected: $COUNT PRs"

      - name: Count repo stats
        id: stats
        run: |
          TOTAL_DOCS=$(find docs/models docs/tools docs/skills docs/repos docs/agents -name '*.md' ! -name '.gitkeep' 2>/dev/null | wc -l | tr -d ' ')
          TOTAL_TRANSCRIPTS=$(find conversations -name 'transcript.md' 2>/dev/null | wc -l | tr -d ' ')
          echo "total_docs=$TOTAL_DOCS" >> "$GITHUB_OUTPUT"
          echo "total_transcripts=$TOTAL_TRANSCRIPTS" >> "$GITHUB_OUTPUT"
          echo "✅ Stats: $TOTAL_DOCS docs, $TOTAL_TRANSCRIPTS transcripts"

      - name: Create newsletter generation issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          DATE="${{ env.NEWSLETTER_DATE }}"
          PR_COUNT="${{ steps.learnings.outputs.pr_count }}"
          TOTAL_DOCS="${{ steps.stats.outputs.total_docs }}"
          TOTAL_TRANSCRIPTS="${{ steps.stats.outputs.total_transcripts }}"

          if [ "$PR_COUNT" -gt 0 ]; then
            PR_SUMMARY=$(jq -r '.[] | "- [#\(.number)](\(.url)) \(.title)"' /tmp/merged_prs.json)
          else
            PR_SUMMARY="No PRs merged in the past 24 hours."
          fi

          gh issue create \
            --repo ${{ github.repository }} \
            --title "newsletter: generate ${DATE}" \
            --body "## Newsletter Generation Request — ${DATE}

Auto-created by the daily newsletter workflow.

### Merged PRs (past 24h): ${PR_COUNT}

${PR_SUMMARY}

### Repo Stats
- Total docs: ${TOTAL_DOCS}
- Total transcripts: ${TOTAL_TRANSCRIPTS}"

          echo "✅ Newsletter generation issue created"
