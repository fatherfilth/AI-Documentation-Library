name: PR Validation

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect branch type
        run: |
          BRANCH="${{ github.head_ref }}"
          if [[ "$BRANCH" =~ ^infra/ ]]; then
            echo "BRANCH_TYPE=infra" >> "$GITHUB_ENV"
            echo "✅ Infrastructure branch detected: $BRANCH — skipping doc validation"
          elif [[ "$BRANCH" =~ ^fix/ ]]; then
            echo "BRANCH_TYPE=fix" >> "$GITHUB_ENV"
            echo "✅ Fix branch detected: $BRANCH — skipping doc validation"
          elif [[ "$BRANCH" =~ ^leaderboard/ ]]; then
            echo "BRANCH_TYPE=leaderboard" >> "$GITHUB_ENV"
            echo "✅ Leaderboard branch detected: $BRANCH — validating leaderboard files only"
          elif [[ "$BRANCH" =~ ^topic/[a-z0-9-]+$ ]]; then
            SLUG="${BRANCH#topic/}"
            if [ ${#SLUG} -gt 40 ]; then
              echo "::error::Slug exceeds 40 chars: $SLUG (${#SLUG} chars)"
              exit 1
            fi
            if [[ "$SLUG" =~ [0-9]{4}-[0-9]{2} ]]; then
              echo "::error::Slug must not contain dates: $SLUG"
              exit 1
            fi
            echo "BRANCH_TYPE=topic" >> "$GITHUB_ENV"
            echo "SLUG=$SLUG" >> "$GITHUB_ENV"
            echo "✅ Topic branch valid: $BRANCH (slug: $SLUG)"
          else
            echo "::error::Branch must match 'topic/<slug>', 'infra/<name>', 'fix/<name>', or 'leaderboard/<name>'. Got: $BRANCH"
            exit 1
          fi

      - name: Detect category and validate doc page exists
        if: env.BRANCH_TYPE == 'topic'
        run: |
          VALID_CATS=("models" "tools" "skills" "repos" "agents" "projects")
          FOUND=false
          for CAT in "${VALID_CATS[@]}"; do
            if [ -f "docs/$CAT/${{ env.SLUG }}.md" ]; then
              echo "CAT=$CAT" >> "$GITHUB_ENV"
              FOUND=true
              echo "✅ Doc page found: docs/$CAT/${{ env.SLUG }}.md"
              break
            fi
          done
          if [ "$FOUND" = false ]; then
            echo "::error::No doc page found at docs/<category>/${{ env.SLUG }}.md for any valid category."
            echo "::error::Valid categories: ${VALID_CATS[*]}"
            exit 1
          fi

      - name: Validate template compliance (no unfilled placeholders)
        if: env.BRANCH_TYPE == 'topic'
        run: |
          DOC="docs/${{ env.CAT }}/${{ env.SLUG }}.md"
          if grep -q '{REQUIRED}' "$DOC"; then
            echo "::error::Doc page contains unfilled {REQUIRED} placeholders:"
            grep -n '{REQUIRED}' "$DOC"
            exit 1
          fi
          echo "✅ No {REQUIRED} placeholders remain"

      - name: Validate transcript archive exists
        if: env.BRANCH_TYPE == 'topic'
        run: |
          TRANSCRIPT=$(find conversations/ -path "*__${{ env.SLUG }}/transcript.md" 2>/dev/null | head -1)
          if [ -z "$TRANSCRIPT" ]; then
            echo "::error::No transcript found matching conversations/YYYY/YYYY-MM-DD__${{ env.SLUG }}/transcript.md"
            exit 1
          fi
          echo "TRANSCRIPT=$TRANSCRIPT" >> "$GITHUB_ENV"
          echo "✅ Transcript found: $TRANSCRIPT"

      - name: Validate transcript frontmatter
        if: env.BRANCH_TYPE == 'topic'
        run: |
          # Check YAML frontmatter exists and has required keys
          HEAD=$(sed -n '1,/^---$/p' "${{ env.TRANSCRIPT }}" | tail -n +2)
          if [ -z "$HEAD" ]; then
            echo "::error::Transcript missing YAML frontmatter block"
            exit 1
          fi
          for KEY in topic date participants source summary; do
            if ! echo "$HEAD" | grep -q "^${KEY}:"; then
              echo "::error::Transcript frontmatter missing required key: $KEY"
              exit 1
            fi
          done
          echo "✅ Transcript frontmatter valid"

      - name: Validate index entry
        if: env.BRANCH_TYPE == 'topic'
        run: |
          if ! grep -q "${{ env.SLUG }}" docs/_index/README.md; then
            echo "::error::No index row found for slug '${{ env.SLUG }}' in docs/_index/README.md"
            exit 1
          fi
          echo "✅ Index row found for ${{ env.SLUG }}"

      - name: Check for bare URLs in doc page
        if: env.BRANCH_TYPE == 'topic'
        run: |
          DOC="docs/${{ env.CAT }}/${{ env.SLUG }}.md"
          # Match bare http(s) URLs not inside markdown link syntax [...](...)
          if grep -Pn '(?<!\()https?://[^\s)]+' "$DOC" | grep -Pv '\[.*\]\(https?://'; then
            echo "::warning::Doc page may contain bare URLs. All links must use [label](url) format."
          fi
          echo "✅ Link format check complete"

      - name: Validate leaderboard files
        if: env.BRANCH_TYPE == 'leaderboard'
        run: |
          # Check that data.yaml exists and is valid YAML
          if [ ! -f "docs/_leaderboard/data.yaml" ]; then
            echo "::error::Leaderboard data file missing: docs/_leaderboard/data.yaml"
            exit 1
          fi
          # Check that README.md exists
          if [ ! -f "docs/_leaderboard/README.md" ]; then
            echo "::error::Leaderboard README missing: docs/_leaderboard/README.md"
            exit 1
          fi
          echo "✅ Leaderboard files present"

      - name: Scan for secrets
        run: |
          PATTERNS=(
            'sk-[a-zA-Z0-9]{20,}'
            'AKIA[A-Z0-9]{16}'
            'ghp_[a-zA-Z0-9]{36}'
            'xoxb-[0-9]{10,}'
            'AIza[a-zA-Z0-9_-]{35}'
          )
          FAILED=false
          for PAT in "${PATTERNS[@]}"; do
            if grep -rPn "$PAT" docs/ conversations/ 2>/dev/null; then
              echo "::error::Possible secret detected matching pattern: $PAT"
              FAILED=true
            fi
          done
          if [ "$FAILED" = true ]; then
            exit 1
          fi
          echo "✅ No secrets detected"

      - name: Summary
        run: |
          if [ "${{ env.BRANCH_TYPE }}" = "topic" ]; then
            echo "## ✅ All checks passed (topic branch)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Branch name | ✅ topic/${{ env.SLUG }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Doc page | ✅ docs/${{ env.CAT }}/${{ env.SLUG }}.md |" >> $GITHUB_STEP_SUMMARY
            echo "| Template compliance | ✅ No unfilled placeholders |" >> $GITHUB_STEP_SUMMARY
            echo "| Transcript | ✅ ${{ env.TRANSCRIPT }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Frontmatter | ✅ All required keys present |" >> $GITHUB_STEP_SUMMARY
            echo "| Index entry | ✅ Row exists |" >> $GITHUB_STEP_SUMMARY
            echo "| Secrets scan | ✅ Clean |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ env.BRANCH_TYPE }}" = "leaderboard" ]; then
            echo "## ✅ All checks passed (leaderboard branch)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Branch type | ✅ leaderboard |" >> $GITHUB_STEP_SUMMARY
            echo "| Leaderboard files | ✅ Present |" >> $GITHUB_STEP_SUMMARY
            echo "| Secrets scan | ✅ Clean |" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ✅ All checks passed (${{ env.BRANCH_TYPE }} branch)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Branch type | ✅ ${{ env.BRANCH_TYPE }} (doc validation skipped) |" >> $GITHUB_STEP_SUMMARY
            echo "| Secrets scan | ✅ Clean |" >> $GITHUB_STEP_SUMMARY
          fi
