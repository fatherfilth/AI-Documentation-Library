name: PR Validation

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate branch name
        run: |
          BRANCH="${{ github.head_ref }}"
          if [[ ! "$BRANCH" =~ ^topic/[a-z0-9-]+$ ]]; then
            echo "::error::Branch must match 'topic/<slug>' (lowercase, hyphenated). Got: $BRANCH"
            exit 1
          fi
          SLUG="${BRANCH#topic/}"
          if [ ${#SLUG} -gt 40 ]; then
            echo "::error::Slug exceeds 40 chars: $SLUG (${#SLUG} chars)"
            exit 1
          fi
          if [[ "$SLUG" =~ [0-9]{4}-[0-9]{2} ]]; then
            echo "::error::Slug must not contain dates: $SLUG"
            exit 1
          fi
          echo "SLUG=$SLUG" >> "$GITHUB_ENV"
          echo "✅ Branch name valid: $BRANCH (slug: $SLUG)"

      - name: Detect category and validate doc page exists
        run: |
          VALID_CATS=("models" "tools" "skills" "repos" "agents")
          FOUND=false
          for CAT in "${VALID_CATS[@]}"; do
            if [ -f "docs/$CAT/${{ env.SLUG }}.md" ]; then
              echo "CAT=$CAT" >> "$GITHUB_ENV"
              FOUND=true
              echo "✅ Doc page found: docs/$CAT/${{ env.SLUG }}.md"
              break
            fi
          done
          if [ "$FOUND" = false ]; then
            echo "::error::No doc page found at docs/<category>/${{ env.SLUG }}.md for any valid category."
            echo "::error::Valid categories: ${VALID_CATS[*]}"
            exit 1
          fi

      - name: Validate template compliance (no unfilled placeholders)
        run: |
          DOC="docs/${{ env.CAT }}/${{ env.SLUG }}.md"
          if grep -q '{REQUIRED}' "$DOC"; then
            echo "::error::Doc page contains unfilled {REQUIRED} placeholders:"
            grep -n '{REQUIRED}' "$DOC"
            exit 1
          fi
          echo "✅ No {REQUIRED} placeholders remain"

      - name: Validate transcript archive exists
        run: |
          TRANSCRIPT=$(find conversations/ -path "*__${{ env.SLUG }}/transcript.md" 2>/dev/null | head -1)
          if [ -z "$TRANSCRIPT" ]; then
            echo "::error::No transcript found matching conversations/YYYY/YYYY-MM-DD__${{ env.SLUG }}/transcript.md"
            exit 1
          fi
          echo "TRANSCRIPT=$TRANSCRIPT" >> "$GITHUB_ENV"
          echo "✅ Transcript found: $TRANSCRIPT"

      - name: Validate transcript frontmatter
        run: |
          # Check YAML frontmatter exists and has required keys
          HEAD=$(sed -n '1,/^---$/p' "${{ env.TRANSCRIPT }}" | tail -n +2)
          if [ -z "$HEAD" ]; then
            echo "::error::Transcript missing YAML frontmatter block"
            exit 1
          fi
          for KEY in topic date participants source summary; do
            if ! echo "$HEAD" | grep -q "^${KEY}:"; then
              echo "::error::Transcript frontmatter missing required key: $KEY"
              exit 1
            fi
          done
          echo "✅ Transcript frontmatter valid"

      - name: Validate index entry
        run: |
          if ! grep -q "${{ env.SLUG }}" docs/_index/README.md; then
            echo "::error::No index row found for slug '${{ env.SLUG }}' in docs/_index/README.md"
            exit 1
          fi
          echo "✅ Index row found for ${{ env.SLUG }}"

      - name: Check for bare URLs in doc page
        run: |
          DOC="docs/${{ env.CAT }}/${{ env.SLUG }}.md"
          # Match bare http(s) URLs not inside markdown link syntax [...](...)
          if grep -Pn '(?<!\()https?://[^\s)]+' "$DOC" | grep -Pv '\[.*\]\(https?://'; then
            echo "::warning::Doc page may contain bare URLs. All links must use [label](url) format."
          fi
          echo "✅ Link format check complete"

      - name: Scan for secrets
        run: |
          PATTERNS=(
            'sk-[a-zA-Z0-9]{20,}'
            'AKIA[A-Z0-9]{16}'
            'ghp_[a-zA-Z0-9]{36}'
            'xoxb-[0-9]{10,}'
            'AIza[a-zA-Z0-9_-]{35}'
          )
          FAILED=false
          for PAT in "${PATTERNS[@]}"; do
            if grep -rPn "$PAT" docs/ conversations/ 2>/dev/null; then
              echo "::error::Possible secret detected matching pattern: $PAT"
              FAILED=true
            fi
          done
          if [ "$FAILED" = true ]; then
            exit 1
          fi
          echo "✅ No secrets detected"

      - name: Summary
        run: |
          echo "## ✅ All checks passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch name | ✅ topic/${{ env.SLUG }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Doc page | ✅ docs/${{ env.CAT }}/${{ env.SLUG }}.md |" >> $GITHUB_STEP_SUMMARY
          echo "| Template compliance | ✅ No unfilled placeholders |" >> $GITHUB_STEP_SUMMARY
          echo "| Transcript | ✅ ${{ env.TRANSCRIPT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontmatter | ✅ All required keys present |" >> $GITHUB_STEP_SUMMARY
          echo "| Index entry | ✅ Row exists |" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets scan | ✅ Clean |" >> $GITHUB_STEP_SUMMARY
